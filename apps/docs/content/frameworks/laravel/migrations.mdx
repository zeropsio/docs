---
title: Database Migrations in Laravel
description: Learn How to Manage and Run Database Migrations for Your Laravel Application on Zerops
---

import Image from '/src/components/Image';

:::note
This guide assumes you're using PostgreSQL, which is the recommended database system on Zerops. While Laravel supports multiple database systems, the examples in this guide are specifically for PostgreSQL.
:::

## Running Migrations

### Automatic Migrations

:::info Configuration Reference
Here you can find some part of `zerops.yml`. For the complete configuration options including service setup, environment variables, and deployment settings, see the [zerops.yml reference guide](/zerops-yml/specification).
:::

To automatically run migrations during deployment, add the migration command to your `zerops.yml`:

```yaml:zerops.yml
zerops:
  - setup: app
    run:
      initCommands:
        - php artisan migrate --force
```

:::caution
The `--force` flag is required when running migrations in production to prevent accidental data loss.
:::

### Manual Migrations

You can also run migrations by connecting to Zerops VPN and then SSHing into your service:

```bash
# Connect to your zerops project
zcli vpn up

# SSH into your service with it's hostname (app)
ssh app

# If you're on MacOS you should use the following command instead
ssh app.zerops
```

## Migration Commands

Common migration commands you can use:

```bash
# Create a new migration
php artisan make:migration create_users_table

# Run pending migrations
php artisan migrate

# Rollback the last migration operation
php artisan migrate:rollback

# Rollback all migrations and run them again
php artisan migrate:fresh

# Show migration status
php artisan migrate:status
```

## Best Practices

### Migration Structure

```php:database/migrations/2024_03_20_create_users_table.php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up()
    {
        Schema::create('users', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('email')->unique();
            $table->timestamp('email_verified_at')->nullable();
            $table->string('password');
            $table->rememberToken();
            $table->timestamps();
        });
    }

    public function down()
    {
        Schema::dropIfExists('users');
    }
};
```

### Safe Migration Practices

1. **Always Include Down Method**
```php
public function down()
{
    // Reverse the changes made in up()
    Schema::table('users', function (Blueprint $table) {
        $table->dropColumn('new_column');
    });
}
```

2. **Use Foreign Keys Properly**
```php
public function up()
{
    Schema::table('posts', function (Blueprint $table) {
        $table->foreignId('user_id')
              ->constrained()
              ->onDelete('cascade');
    });
}
```

3. **Handle Large Tables**
```php
public function up()
{
    Schema::table('large_table', function (Blueprint $table) {
        $table->string('new_column')->nullable(); // Allow null first
    });
    
    // Update data in chunks
    DB::table('large_table')->orderBy('id')->chunk(1000, function ($records) {
        foreach ($records as $record) {
            DB::table('large_table')
                ->where('id', $record->id)
                ->update(['new_column' => 'default_value']);
        }
    });
}
```

## Environment Configuration

Configure your database connection in your environment variables:

```yaml
zerops:
  - setup: app
    run:
      envVariables:
        DB_CONNECTION: pgsql
        DB_HOST: ${db_hostname}
        DB_PORT: 5432
        DB_DATABASE: myapp
        DB_USERNAME: ${db_user}
        DB_PASSWORD: ${db_password}
```

## Testing Migrations

### Create Test Database

Add a testing connection to your `config/database.php`:

```php
'testing' => [
    'driver' => 'pgsql',
    'host' => env('DB_TEST_HOST', '127.0.0.1'),
    'database' => env('DB_TEST_DATABASE', 'testing'),
    'username' => env('DB_TEST_USERNAME', 'postgres'),
    'password' => env('DB_TEST_PASSWORD', ''),
],
```

### Migration Testing Example

Add a migration test file at `tests/Unit/MigrationTest.php`:

```php
public function test_migrations_can_be_run()
{
    // Run migrations
    Artisan::call('migrate');

    // Assert the table exists
    $this->assertTrue(Schema::hasTable('users'));
    
    // Assert columns exist
    $this->assertTrue(Schema::hasColumns('users', [
        'id', 'name', 'email', 'password'
    ]));
}
```

:::tip Migration Tips
- Always backup your database before running migrations in production
- Use transactions for complex migrations
- Test migrations thoroughly in development
- Consider using seeders for initial data
- Monitor migration execution time for large tables
:::

## Troubleshooting

Common migration issues and solutions:

1. **Migration Timeout** while running migrations in [zerops.yml](/zerops-yml/specification):
```yaml
zerops:
  - setup: app
    run:
      initCommands:
        - php artisan migrate --force --timeout=1000
```

2. **Lock Timeout** in `config/database.php`:
```php
'pgsql' => [
    // ...
    'options' => [
        PDO::ATTR_LOCK_TIMEOUT => 1000
    ]
],
```

3. **Reset Migration State** Commands:
```bash
php artisan migrate:reset
php artisan migrate
```

